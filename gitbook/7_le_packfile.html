<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
  "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<title>Git Book - Le Packfile</title>
	<meta http-equiv="content-language" content="en">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="icon" href="favicon.png" type="image/png">
	<link rel="stylesheet" href="assets/blueprint/screen.css" type="text/css" media="screen, projection">
  <link rel="stylesheet" href="assets/blueprint/print.css" type="text/css" media="print">
  <!--[if IE]><link rel="stylesheet" href="assets/blueprint/ie.css" type="text/css" media="screen, projection"><![endif]-->
	<link rel="stylesheet" href="assets/stylesheets/mac_classic.css" type="text/css" media="screen, projection">
	<link rel="stylesheet" href="assets/stylesheets/style.css" type="text/css" media="screen, projection">
</head>

<body>
<div class="container chapter showgrids">

  <div class="span-21 header">
    <div class="nav"><a href="7_l'index_git.html">Prev</a>  <a href="7_raw_git.html">Next</a></div>
    <div class="title"><a href='index.html'>Git Community Book</a></div>
  </div>
  
  <div class="span-21">
    <br/>
  </div>
  
  <div class="span-21">
    <h2>Le Packfile </h2>

<p>Ce chapitre explique en détails, au bit près, comment le packfile et
les fichier d'index de pack sont formatés.</p>

<h3>L'Index Packfile </h3>

<p>Premièrement, nous avons l'index packfile, qui est simplement juste une série
de marque-pages vers le packfile.</p>

<p>Il existe 2 versions de l'index packfile - version 1, qui est celle par
défaut dans les version de Git antérieures à 1.6, et la version 2, qui est
celle par défaut depuis Git v1.6, et qui peut être lue par Git jusqu'à la
v1.5.2, et qui a aussi était portée sur la v1.4.4.5 sur vous travaillez
toujours dans la série 1.4.</p>

<p>La version 2 inclue un checksum CRC pour chaque objet afin que les données
compressées puissent être copiées directement entre les pack durant les
re-package sans se retrouver avec de données corrumpues non-détectées.
Les index de version 2 peuvent aussi s'occuper de packfiles supérieurs
à 4Go.</p>

<p><div class="center"><img src="assets/images/figure/packfile-index.png"></div></p>

<p>Dans les 2 formats, la table de routage (fanout) est simplement 
un manière plus rapide de trouver dans le fichier d'index l'offset
d'un SHA particulier. Les tables offset/sha1[] sont triées par
valeurs sha1[]  (cela permet les recherches binaires sur cette table),
et la table fanout[] pointe vers la table offset/sha1[] de façon spécifique
(pour que la part de la dernière table qui convertie tous les hash commençant
par un bit en particulier afin qu'ils puissent être trouvés en évitant les
8 itérations de la recherche binaire).</p>

<p>Dans la version 1, les offsets et SHAs sont au même endroit, alors que dans la
version 2, il y a des tables séparés pour les SHAs, les checksums CRC et les
offsets. Les checksums SHAs pour le fichier d'index et le packfile se trouvent
à la fin de chacun de ces fichiers.</p>

<p>Il es important de noter que les index de packfile <em>ne sont pas</em> nécessaires
pour extraire les objets d'un packfile, ils sont juste utilisé pour retrouver
<em>rapidement</em> des objets individuels depuis un pack. Le format du packfile est
utilisé dans les programmes upload-pack et receive-pack (protocoles de
publication - push - et de récupération - fetch) pour transférer les objets,
et il n'y a alors pas d'index utilisé - il peut être construit après coup en
scannant le packfile.</p>

<h3>Le Format du Packfile </h3>

<p>Le format du packfile même est très simple. Il y a une entête, une série
d'objets packagés (chacun avec sa propre entête et son propre corps), puis
un checksum à la fin. Les 4 premiers bits forment a chaîne de caractère "PACK",
qui est utilisée pour être sûr que vous lisez correctement le début du packfile.
Ceci est suivi d'un numéro de version du packfile sur 4 bits, puis 4 autres bis
représentant le nombre d'entrées dans ce fichier. En Ruby, vous pourriez lire
les données de l'entête de cette manière:</p>

<pre class="mac_classic">
<span class="Keyword">def</span> <span class="FunctionName">read_pack_header</span>
  sig <span class="Keyword">=</span> <span class="Variable"><span class="Variable">@</span>session</span>.<span class="FunctionName">recv</span>(<span class="Number">4</span>)
  ver <span class="Keyword">=</span> <span class="Variable"><span class="Variable">@</span>session</span>.<span class="FunctionName">recv</span>(<span class="Number">4</span>).<span class="FunctionName">unpack</span>(<span class="String"><span class="String">&quot;</span>N<span class="String">&quot;</span></span>)[<span class="Number">0</span>]
  entries <span class="Keyword">=</span> <span class="Variable"><span class="Variable">@</span>session</span>.<span class="FunctionName">recv</span>(<span class="Number">4</span>).<span class="FunctionName">unpack</span>(<span class="String"><span class="String">&quot;</span>N<span class="String">&quot;</span></span>)[<span class="Number">0</span>]
  [sig, ver, entries]
<span class="Keyword">end</span>
</pre>

<p>Après ça, vous avec une suite d'objets packagés, ordonnés par leur SHA,
chacun représenté par l'entête de l'objet et son contenu. Une somme SHA
de 20 bits de tous les SHAs du packfile se trouve dans les 20 bits à la fin
du fichier.</p>

<p><div class="center"><img src="assets/images/figure/packfile-format.png"></div></p>

<p>L'entête de l'objet est une série de un ou plusieurs morceaux d'octets (8 bits)
qui définissent le type d'objet représenté par les données qui suivent, et la
taille de l'objet quand il est décompressé. Chaque octet ne contient
réellement que 7 bits de données, le premier bit ne disant que si cet octet
est le dernier avant que ne commence les données. Si le premier bit est 1, vous
pourrez continuer à lire le prochain octet. sinon les données commencent au
prochain octet. Les 3 premiers bits du premier octet spécifient le type de
données, en accord avec la table ci-dessous.</p>

<p>(Actuellement, sur les 8 valeurs qui peuvent être exprimées avec 3 bits (0-7),
0 (000) est 'undefined' et 5 (101) n'est pas encore utilisée.)</p>

<p>Nous pouvons voir ici un exemple d'entête de 2 octets, où le premier spécifie
que les données suivantes sont un commit, et le le reste des bits du premier octet
accompagnés de ceux du second octet spécifient que les données feront 144 octets
une fois décomprimés.</p>

<p><div class="center"><img src="assets/images/figure/packfile-logic.png"></div></p>

<p>Il est important de savoir que la taille spécifiée dans les données de
l'entête n'est pas la taille des données qui suivent, mais la taille des
données <em>une fois décomprimés</em>. C'est pourquoi les offset de l'index
du packfile sont si utiles, sinon vous devriez décompresser chaque objet
juste pour savoir quand la prochaine entête commence.</p>

<p>La partie donnée n'est qu'un stream zlib pour des types d'objet non-delta;
pour la représentation de 2 objets delta, la portion de donnée contient
quelque chose qui identifie de quel objet de base dépend cet objet delta,
et le delta à appliquer sur l'objet de base pour retrouver cet objet.
<code>ref-delta</code> utilise un hash de 20 octets pour l'objet de base
au début des données, alors que <code>ofs-delta</code> stocke un offset
à l'intérieur du même packfile pour identifier l'objet de base. Dans chacun
des cas, vous devez suivre 2 contraintes importantes si vous voulez
ré-implémenter ce fonctionnement:</p>

<ul>
<li>la représentation du delta doit être basée sur quelqu'autre objet
  à l'intérieur du même packfile;</li>
<li>l'objet de base doit être de même type sous-jacent (blob, tree, commit
  ou tag);</li>
</ul>



  </div>
  
  <div class="span-21">
    <hr/>
    <div class="center"><a href="7_l'index_git.html">Prev</a>  <a href="7_raw_git.html">Next</a></div>
    <hr/>
  </div>
  
  <div class="span-17 footer">
  	<div class="menu">
  		This book is maintained by Scott Chacon, and hosting is donated by GitHub.
  		<br>
  		Please email me at <a href="mailto:schacon@gmail.com">schacon@gmail.com</a>
  		with patches, suggestions and comments.
	  </div>
  </div>
  <div class="span-4 last center">
    <a href="http://github.com"><img src="assets/images/github.png" alt="github logo"></a>
  </div>
  
</div>

<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-82337-12");
pageTracker._initData();
pageTracker._trackPageview();
</script>
<script src="http://static.getclicky.com/40584.js" type="text/javascript"></script>
<noscript><p><img alt="Clicky" src="http://in.getclicky.com/40584-db6.gif" /></p></noscript>

</body>
</html>
